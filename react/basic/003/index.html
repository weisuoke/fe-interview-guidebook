<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <script>
      window.routerBase = "/";
    </script>
    <script>
      //! umi version: 3.5.21
    </script>
    <script>
      !(function () {
        var e = localStorage.getItem("dumi:prefers-color"),
          t = window.matchMedia("(prefers-color-scheme: dark)").matches,
          r = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === r[2] ? (t ? r[1] : r[0]) : r.indexOf(e) > -1 ? e : r[0]
        );
      })();
    </script>
    <title>HOC - 前端面试手册</title>
  
</head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/react/basic/003" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" href="/">前端面试手册</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span><a href="/js">JavaScript</a></span><span><a href="/css">CSS</a></span><span><a aria-current="page" class="active" href="/react">React</a></span><span><a href="/explorer">浏览器</a></span><span><a href="/network">网络</a></span><span><a href="/webpack">Webpack</a></span><span><a href="/node">Node</a></span><span><a href="/gof">设计模式</a></span><span><a href="/security">安全</a></span><span><a href="/algorithm">算法</a></span><span><a href="/skill">软技能</a></span><span><a href="/v8">V8</a></span><span><a href="/optimize">性能优化</a></span><span><a href="/wiki">Wiki</a></span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" href="/"></a><h1>前端面试手册</h1><p>前端面试手册</p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a href="/js">JavaScript</a></li><li><a href="/css">CSS</a></li><li><a aria-current="page" class="active" href="/react">React</a></li><li><a href="/explorer">浏览器</a></li><li><a href="/network">网络</a></li><li><a href="/webpack">Webpack</a></li><li><a href="/node">Node</a></li><li><a href="/gof">设计模式</a></li><li><a href="/security">安全</a></li><li><a href="/algorithm">算法</a></li><li><a href="/skill">软技能</a></li><li><a href="/v8">V8</a></li><li><a href="/optimize">性能优化</a></li><li><a href="/wiki">Wiki</a></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a target="_blank" rel="noopener noreferrer">基础</a><ul><li><a href="/react"><span>概述</span></a></li><li><a href="/react/basic/001"><span>setState的执行机制</span></a></li><li><a href="/react/basic/002"><span>合成事件</span></a></li><li><a aria-current="page" class="active" href="/react/basic/003"><span>HOC</span></a></li><li><a href="/react/basic/004"><span>Fiber</span></a></li></ul></li><li><a target="_blank" rel="noopener noreferrer">Redux</a><ul><li><a href="/react/redux/001"><span>Reudx原则</span></a></li></ul></li><li><a target="_blank" rel="noopener noreferrer">一灯学堂</a><ul><li><a href="/react/yideng"><span>React面试题</span></a></li><li><a href="/react/yideng/001"><span>React组件通信</span></a></li><li><a href="/react/yideng/003"><span>redux-saga 和 mobx 的比较</span></a></li><li><a href="/react/yideng/004"><span>React 项目中有哪些细节可以优化？实际开发中都做过哪些性能优化</span></a></li><li><a href="/react/yideng/005"><span>React 事件绑定原理</span></a></li><li><a href="/react/yideng/006"><span>react 最新版本解决了什么问题 加了哪些东西</span></a></li><li><a href="/react/yideng/009"><span>React兄弟组件的通信方式？</span></a></li><li><a href="/react/yideng/010"><span>Fiber算法原理，相比之前的stack算法哪些方面做了优化</span></a></li><li><a href="/react/yideng/012"><span>Props和State的区别</span></a></li><li><a href="/react/yideng/013"><span>对无状态组件的理解</span></a></li><li><a href="/react/yideng/016"><span>Redux 和全局管理有什么区别</span></a></li><li><a href="/react/yideng/017"><span>哪些方法会触发react重新渲染？重新渲染render会做些什么？</span></a></li><li><a href="/react/yideng/020"><span>React中setState后发生了什么？setState为什么默认是异步？setState什么时候是同步？</span></a></li><li><a href="/react/yideng/031"><span>Redux如何优化？</span></a></li><li><a href="/react/yideng/032"><span>如何实现 Redux 异步功能？</span></a></li><li><a href="/react/yideng/033"><span>说说 React 状态复用问题</span></a></li><li><a href="/react/yideng/034"><span>React Hooks 实现原理</span></a></li></ul></li><li><a target="_blank" rel="noopener noreferrer">React基础</a><ul><li><a href="/react/1.basic/01"><span>说一下你对React的理解</span></a></li><li><a href="/react/1.basic/02"><span>为什么React会引入JSX?</span></a></li><li><a href="/react/1.basic/03"><span>请说一下你对 Virtual DOM的理解？</span></a></li><li><a href="/react/1.basic/04"><span>函数组件和类组件的相同点和不同点?</span></a></li><li><a href="/react/1.basic/05"><span>请说一下 React 中的渲染流程</span></a></li><li><a href="/react/1.basic/06"><span>请说一下React中有DOM-DIFF算法?</span></a></li><li><a href="/react/1.basic/07"><span>合成事件</span></a></li><li><a href="/react/1.basic/08"><span>setState是同步的还是异步的</span></a></li></ul></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="什么是高阶组件？" data-depth="2"><a href="/react/basic/003#什么是高阶组件"><span>什么是高阶组件？</span></a></li><li title="HOC 工厂的实现方法" data-depth="2"><a href="/react/basic/003#hoc-工厂的实现方法"><span>HOC 工厂的实现方法</span></a></li><li title="Props Proxy" data-depth="3"><a href="/react/basic/003#props-proxy"><span>Props Proxy</span></a></li><li title="Inheritance Inversion" data-depth="3"><a href="/react/basic/003#inheritance-inversion"><span>Inheritance Inversion</span></a></li><li title="Inheritance Inversion 的高阶组件不一定会解析完整子树" data-depth="2"><a href="/react/basic/003#inheritance-inversion-的高阶组件不一定会解析完整子树"><span>Inheritance Inversion 的高阶组件不一定会解析完整子树</span></a></li><li title="命名" data-depth="3"><a href="/react/basic/003#命名"><span>命名</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="深入理解-react-高阶组件"><a aria-hidden="true" tabindex="-1" href="/react/basic/003#深入理解-react-高阶组件"><span class="icon icon-link"></span></a>深入理解 React 高阶组件</h1><h2 id="什么是高阶组件"><a aria-hidden="true" tabindex="-1" href="/react/basic/003#什么是高阶组件"><span class="icon icon-link"></span></a><strong>什么是高阶组件？</strong></h2><blockquote><p>高阶组件就是一个 React 组件包裹着另外一个 React 组件</p></blockquote><p>这种模式通常使用函数来实现，基本上是一个类工厂（是的，一个类工厂！），它的函数签名可以用类似 haskell 的伪代码表示</p><div class="__dumi-default-code-block"><pre class="prism-code language-text"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">hocFactory:: W: React.Component =&gt; E: React.Component</span></div></pre></div><p>其中 W (WrappedComponent) 指被包裹的 React.Component，E (EnhancedComponent) 指返回类型为 React.Component 的新的 HOC。</p><p>我们有意模糊了定义中“包裹”的概念，因为它可能会有以下两种不同的含义之一：</p><ol><li>Props Proxy： HOC 对传给 WrappedComponent W 的 porps 进行操作，</li><li>Inheritance Inversion： HOC 继承 WrappedComponent W。</li></ol><p>（译注：原作者在评论中提到希望对 Props Proxy 和 Inheritance Inversion 不做翻译，故保留原文）</p><p>我们会深入地探究这两种模式。</p><h2 id="hoc-工厂的实现方法"><a aria-hidden="true" tabindex="-1" href="/react/basic/003#hoc-工厂的实现方法"><span class="icon icon-link"></span></a><strong>HOC 工厂的实现方法</strong></h2><p>这一节我们将会研究 React 中两种 HOC 的实现方法：Props Proxy (PP) and Inheritance Inversion (II)。两种方法都可以操作 WrappedComponent。</p><h3 id="props-proxy"><a aria-hidden="true" tabindex="-1" href="/react/basic/003#props-proxy"><span class="icon icon-link"></span></a><strong>Props Proxy</strong></h3><p>Props Proxy (PP) 的最简实现：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">ppHOC</span><span class="token punctuation">(</span><span class="token parameter maybe-class-name">WrappedComponent</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain">  </span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">PP</span><span class="token plain"> </span><span class="token keyword">extends</span><span class="token plain"> </span><span class="token class-name">React</span><span class="token class-name punctuation">.</span><span class="token class-name">Component</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    </span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain">      </span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token maybe-class-name">WrappedComponent</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token spread operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain">  </span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>这里主要是 HOC 在 render 方法中 <strong>返回</strong> 了一个 <em>WrappedComponent</em> 类型的 React Element。我们还传入了 HOC 接收到的 props，这就是名字 <strong>Props Proxy</strong> 的由来。</p><p>注：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token operator">&lt;</span><span class="token maybe-class-name">WrappedComponent</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token spread operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 等价于</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token maybe-class-name">React</span><span class="token punctuation">.</span><span class="token method function property-access">createElement</span><span class="token punctuation">(</span><span class="token maybe-class-name">WrappedComponent</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span></div></pre></div><p>在 React 内部的一致化处理（reconciliation process）中，两者都创建了一个 React Element 用于渲染。如果你想了解关于 React Elements vs Components ，请看 Dan Abramov 的这篇文章，想了解一致化处理请参考文档。</p><p>（译注：一致化处理（reconciliation process）可理解为 React 内部将虚拟 DOM 同步更新到真实 DOM 的过程，包括新旧虚拟 DOM 的比较及计算最小 DOM 操作）</p><p><strong>使用 Props Proxy 可以做什么？</strong></p><ul><li>操作 props</li><li>通过 Refs 访问到组件实例</li><li>提取 state</li><li>用其他元素包裹 <em>WrappedComponent</em></li></ul><p><strong>操作 props</strong></p><p>你可以读取、添加、编辑、删除传给 <em>WrappedComponent</em> 的 props。</p><p>当删除或者编辑重要的 props 时要小心，你可能应该通过命名空间确保高阶组件的 props 不会破坏 <em>WrappedComponent</em>。</p><p>例子：添加新的 props。在这个应用中，当前登录的用户可以在 <em>WrappedComponent</em> 中通过 <em>this.props.user</em> 访问到。</p><div class="__dumi-default-code-block"><pre class="prism-code language-text"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">function ppHOC(WrappedComponent) {</span></div><div class="token-line"><span class="token plain">  return class PP extends React.Component {</span></div><div class="token-line"><span class="token plain">    render() {</span></div><div class="token-line"><span class="token plain">      const newProps = {</span></div><div class="token-line"><span class="token plain">        user: currentLoggedInUser</span></div><div class="token-line"><span class="token plain">      }</span></div><div class="token-line"><span class="token plain">      return &lt;WrappedComponent {...this.props} {...newProps}/&gt;</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">  }</span></div><div class="token-line"><span class="token plain">}</span></div></pre></div><p><strong>通过 Refs 访问到组件实例</strong></p><p>你可以通过<em>引用</em>（<em>ref</em>）访问到 <em>this</em> （<em>WrappedComponent</em> 的实例），但为了得到引用，<em>WrappedComponent</em> 还需要一个初始渲染，意味着你需要在 HOC 的 render 方法中返回 <em>WrappedComponent</em> 元素，让 React 开始它的一致化处理，你就可以得到 <em>WrappedComponent</em> 的实例的引用。</p><p>例子：如何通过 <a target="_blank" rel="noopener noreferrer" href="https://link.zhihu.com/?target=https%3A//facebook.github.io/react/docs/more-about-refs.html">refs<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 访问到实例的方法和实例本身：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">refsHOC</span><span class="token punctuation">(</span><span class="token parameter maybe-class-name">WrappedComponent</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">RefsHOC</span><span class="token plain"> </span><span class="token keyword">extends</span><span class="token plain"> </span><span class="token class-name">React</span><span class="token class-name punctuation">.</span><span class="token class-name">Component</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">proc</span><span class="token punctuation">(</span><span class="token parameter">wrappedComponentInstance</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      wrappedComponentInstance</span><span class="token punctuation">.</span><span class="token method function property-access">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">    </span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> props </span><span class="token operator">=</span><span class="token plain"> </span><span class="token known-class-name class-name">Object</span><span class="token punctuation">.</span><span class="token method function property-access">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token literal-property property">ref</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">proc</span><span class="token punctuation">.</span><span class="token method function property-access">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token maybe-class-name">WrappedComponent</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token spread operator">...</span><span class="token plain">props</span><span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>Ref 的回调函数会在 WrappedComponent 渲染时执行，你就可以得到 <em>WrappedComponent</em> 的引用。这可以用来读取/添加实例的 props ，调用实例的方法。</p><p><strong>提取 state</strong></p><p>你可以通过传入 props 和回调函数把 state 提取出来，类似于 smart component 与 dumb component。更多关于 <a target="_blank" rel="noopener noreferrer" href="https://link.zhihu.com/?target=https%3A//medium.com/%40dan_abramov/smart-and-dumb-components-7ca2f9a7c7d0%23.o2qmm6j3h">dumb and smart component<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p><p>提取 state 的例子：提取了 input 的 <em>value</em> 和 <em>onChange</em> 方法。这个简单的例子不是很常规，但足够说明问题。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">ppHOC</span><span class="token punctuation">(</span><span class="token parameter maybe-class-name">WrappedComponent</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">PP</span><span class="token plain"> </span><span class="token keyword">extends</span><span class="token plain"> </span><span class="token class-name">React</span><span class="token class-name punctuation">.</span><span class="token class-name">Component</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">super</span><span class="token punctuation">(</span><span class="token plain">props</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">onNameChange</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">onNameChange</span><span class="token punctuation">.</span><span class="token method function property-access">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">onNameChange</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token plain"> event</span><span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> newProps </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token literal-property property">value</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token literal-property property">onChange</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">onNameChange</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token maybe-class-name">WrappedComponent</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token spread operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token spread operator">...</span><span class="token plain">newProps</span><span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>你可以这样用：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">@ppHOC</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">Example</span><span class="token plain"> </span><span class="token keyword">extends</span><span class="token plain"> </span><span class="token class-name">React</span><span class="token class-name punctuation">.</span><span class="token class-name">Component</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain">input name</span><span class="token operator">=</span><span class="token string">&quot;name&quot;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token spread operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>这个 input 会自动成为<a target="_blank" rel="noopener noreferrer" href="https://link.zhihu.com/?target=https%3A//facebook.github.io/react/docs/forms.html">受控input<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p><blockquote><p><strong>更多关于常规的双向绑定 HOC 请点击 <a target="_blank" rel="noopener noreferrer" href="https://link.zhihu.com/?target=https%3A//github.com/franleplant/react-hoc-examples/blob/master/pp_state.js">链接<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></strong></p></blockquote><p><strong>用其他元素包裹 WrappedComponent</strong></p><p>为了封装样式、布局或别的目的，你可以用其它组件和元素包裹 <em>WrappedComponent</em>。基本方法是使用父组件（附录 B）实现，但通过 HOC 你可以得到更多灵活性。</p><p>例子：包裹样式</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">ppHOC</span><span class="token punctuation">(</span><span class="token parameter maybe-class-name">WrappedComponent</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">PP</span><span class="token plain"> </span><span class="token keyword">extends</span><span class="token plain"> </span><span class="token class-name">React</span><span class="token class-name punctuation">.</span><span class="token class-name">Component</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token operator">&lt;</span><span class="token plain">div style</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token literal-property property">display</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;block&#x27;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token operator">&lt;</span><span class="token maybe-class-name">WrappedComponent</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token spread operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">div</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><h3 id="inheritance-inversion"><a aria-hidden="true" tabindex="-1" href="/react/basic/003#inheritance-inversion"><span class="icon icon-link"></span></a><strong>Inheritance Inversion</strong></h3><p>Inheritance Inversion (II) 的最简实现：</p><div class="__dumi-default-code-block"><pre class="prism-code language-text"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">function iiHOC(WrappedComponent) {</span></div><div class="token-line"><span class="token plain">  return class Enhancer extends WrappedComponent {</span></div><div class="token-line"><span class="token plain">    render() {</span></div><div class="token-line"><span class="token plain">      return super.render()</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">  }</span></div><div class="token-line"><span class="token plain">}</span></div></pre></div><p>你可以看到，返回的 HOC 类（Enhancer）<strong>继承</strong>了 <em>WrappedComponent</em>。之所以被称为 Inheritance Inversion 是因为 <em>WrappedComponent</em> 被 <em>Enhancer</em> 继承了，而不是 <em>WrappedComponent</em> 继承了 <em>Enhancer</em>。在这种方式中，它们的关系看上去被**反转（inverse）**了。</p><p>Inheritance Inversion 允许 HOC 通过 <em>this</em> 访问到 <em>WrappedComponent</em>，意味着<strong>它可以访问到 state、props、组件生命周期方法和 render 方法</strong>。</p><p>关于生命周期方法可以用来做什么，我不想细说，因为它是 React 的特性而不是 HOC 的特性。但请注意通过 II 你可以创建新的生命周期方法。为了不破坏 <em>WrappedComponent</em>，记得调用 <em>super.[lifecycleHook]</em>。</p><p><strong>一致化处理（Reconciliation process）</strong></p><p>开始之前我们先理清一些概念。</p><p>React 元素决定描述了在 React 执行<a target="_blank" rel="noopener noreferrer" href="https://link.zhihu.com/?target=https%3A//facebook.github.io/react/docs/reconciliation.html">一致化<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>处理时它要渲染什么。</p><p>React 元素有两种类型：字符串和函数。字符串类型的 React 元素代表 DOM 节点，函数类型的 React 元素代表继承 React.Component 的组件。更多关于元素（Element）和组件（Component）请看<a target="_blank" rel="noopener noreferrer" href="https://link.zhihu.com/?target=https%3A//facebook.github.io/react/blog/2015/12/18/react-components-elements-and-instances.html">这篇文章<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p><p>函数类型的 React 元素会在<a target="_blank" rel="noopener noreferrer" href="https://link.zhihu.com/?target=https%3A//facebook.github.io/react/docs/reconciliation.html">一致化<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>处理中被解析成一个完全由字符串类型 React 组件组成的树（而最后的结果永远是 DOM 元素）。</p><p>这很重要，意味着 <strong>Inheritance Inversion 的高阶组件不一定会解析完整子树</strong></p><blockquote><h2 id="inheritance-inversion-的高阶组件不一定会解析完整子树"><a aria-hidden="true" tabindex="-1" href="/react/basic/003#inheritance-inversion-的高阶组件不一定会解析完整子树"><span class="icon icon-link"></span></a><em>Inheritance Inversion 的高阶组件不一定会解析完整子树</em></h2></blockquote><p>这在学习渲染劫持（Render Highjacking）时非常重要。</p><p><strong>你可以用 Inheritance Inversion 做什么？</strong></p><ul><li>渲染劫持（Render Highjacking）</li><li>操作 state</li></ul><p><strong>渲染劫持</strong></p><p>之所以被称为渲染劫持是因为 HOC 控制着 <em>WrappedComponent</em> 的渲染输出，可以用它做各种各样的事。</p><p>通过渲染劫持你可以：</p><ul><li>在由 <em>render</em><strong>输出</strong>的任何 React 元素中读取、添加、编辑、删除 props</li><li>读取和修改由 <em>render</em> 输出的 React 元素树</li><li>有条件地渲染元素树</li><li>把样式包裹进元素树（就像在 Props Proxy 中的那样）</li></ul><p>*<em>render</em> 指 <em>WrappedComponent</em>.<em>render</em> 方法</p><blockquote><p><em>你<strong>不能</strong>编辑或添加 WrappedComponent 实例的 props，因为 React 组件不能编辑它接收到的 props，但你<strong>可以</strong>修改由 <strong>render</strong> 方法返回的组件的 props。</em></p></blockquote><p>就像我们刚才学到的，II 类型的 HOC 不一定会解析完整子树，意味着渲染劫持有一些限制。根据经验，使用渲染劫持你可以完全操作</p><p><em>WrappedComponent</em></p><p>的 render 方法返回的元素树。但是如果元素树包括一个函数类型的 React 组件，你就不能操作它的子组件了。（被 React 的一致化处理推迟到了真正渲染到屏幕时）</p><p>例1：条件渲染。当 <em>this.props.loggedIn</em> 为 true 时，这个 HOC 会完全渲染 <em>WrappedComponent</em> 的渲染结果。（假设 HOC 接收到了 loggedIn 这个 prop）</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">iiHOC</span><span class="token punctuation">(</span><span class="token parameter maybe-class-name">WrappedComponent</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">Enhancer</span><span class="token plain"> </span><span class="token keyword">extends</span><span class="token plain"> </span><span class="token class-name">WrappedComponent</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">.</span><span class="token property-access">loggedIn</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token method function property-access">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>例2：修改由 <em>render</em> 方法输出的 React 组件树。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">iiHOC</span><span class="token punctuation">(</span><span class="token parameter maybe-class-name">WrappedComponent</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">Enhancer</span><span class="token plain"> </span><span class="token keyword">extends</span><span class="token plain"> </span><span class="token class-name">WrappedComponent</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> elementsTree </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token method function property-access">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">let</span><span class="token plain"> newProps </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">elementsTree </span><span class="token operator">&amp;&amp;</span><span class="token plain"> elementsTree</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&#x27;input&#x27;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        newProps </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token literal-property property">value</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;may the force be with you&#x27;</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> props </span><span class="token operator">=</span><span class="token plain"> </span><span class="token known-class-name class-name">Object</span><span class="token punctuation">.</span><span class="token method function property-access">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> elementsTree</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">,</span><span class="token plain"> newProps</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> newElementsTree </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">React</span><span class="token punctuation">.</span><span class="token method function property-access">cloneElement</span><span class="token punctuation">(</span><span class="token plain">elementsTree</span><span class="token punctuation">,</span><span class="token plain"> props</span><span class="token punctuation">,</span><span class="token plain"> elementsTree</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">.</span><span class="token property-access">children</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> newElementsTree</span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>在这个例子中，如果 <em>WrappedComponent</em> 的输出在最顶层有一个 input，那么就把它的 value 设为 <em>“may the force be with you”</em>。</p><p>你可以在这里做各种各样的事，你可以遍历整个元素树，然后修改元素树中任何元素的 props。这也正是样式处理库 <a target="_blank" rel="noopener noreferrer" href="https://link.zhihu.com/?target=http%3A//stack.formidable.com/radium/">Radium<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 所用的方法（案例分析一节中有更多关于 Radium 的信息）。</p><blockquote><p><em>注：在 Props Proxy 中<strong>不能</strong>做到渲染劫持。</em></p><p><em>虽然通过 WrappedComponent.prototype.render 你可以访问到 render 方法，不过还需要模拟 WrappedComponent 的实例和它的 props，还可能亲自处理组件的生命周期，而不是交给 React。根据我的实验，这么做不值，你要是想做到渲染劫持你应该用 Inheritance Inversion 而不是 Props Proxy。记住，React 在内部处理了组件实例，你处理实例的唯一方法是通过 <strong>this</strong> 或者 refs。</em></p></blockquote><p><strong>操作 state</strong></p><p>HOC 可以读取、编辑和删除 <em>WrappedComponent</em> 实例的 state，如果你需要，你也可以给它添加更多的 state。记住，这会搞乱 <em>WrappedComponent</em> 的 state，导致你可能会破坏某些东西。要限制 HOC 读取或添加 state，添加 state 时应该放在单独的命名空间里，而不是和 <em>WrappedComponent</em> 的 state 混在一起。</p><p>例子：通过访问 <em>WrappedComponent</em> 的 props 和 state 来做调试。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token constant">IIHOCDEBUGGER</span><span class="token punctuation">(</span><span class="token parameter maybe-class-name">WrappedComponent</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">II</span><span class="token plain"> </span><span class="token keyword">extends</span><span class="token plain"> </span><span class="token class-name">WrappedComponent</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token operator">&lt;</span><span class="token plain">div</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token operator">&lt;</span><span class="token plain">h2</span><span class="token operator">&gt;</span><span class="token constant">HOC</span><span class="token plain"> </span><span class="token maybe-class-name">Debugger</span><span class="token plain"> </span><span class="token maybe-class-name">Component</span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">h2</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token operator">&lt;</span><span class="token plain">p</span><span class="token operator">&gt;</span><span class="token maybe-class-name">Props</span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">p</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain">pre</span><span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">stringify</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">pre</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token operator">&lt;</span><span class="token plain">p</span><span class="token operator">&gt;</span><span class="token maybe-class-name">State</span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">p</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token plain">pre</span><span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">stringify</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">pre</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">{</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token method function property-access">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">div</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>这里 HOC 用其他元素包裹着 <em>WrappedComponent</em>，还输出了 <em>WrappedComponent</em> 实例的 props 和 state。<em>JSON.stringify</em> 的小技巧是由 <a target="_blank" rel="noopener noreferrer" href="https://link.zhihu.com/?target=https%3A//twitter.com/ryanflorence">Ryan Florence<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 和 <a target="_blank" rel="noopener noreferrer" href="https://link.zhihu.com/?target=https%3A//twitter.com/mjackson">Michael Jackson<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 教我的。这个调试器完整的实现在<a target="_blank" rel="noopener noreferrer" href="https://link.zhihu.com/?target=https%3A//github.com/franleplant/react-hoc-examples/blob/master/ii_debug.js">这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p><h3 id="命名"><a aria-hidden="true" tabindex="-1" href="/react/basic/003#命名"><span class="icon icon-link"></span></a><strong>命名</strong></h3><p>用 HOC 包裹了一个组件会使它失去原本 <em>WrappedComponent</em> 的名字，可能会影响开发和调试。</p><p>通常会用 <em>WrappedComponent</em> 的名字加上一些 前缀作为 HOC 的名字。下面的代码来自 React-Redux：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token constant">HOC</span><span class="token punctuation">.</span><span class="token property-access">displayName</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">HOC(</span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation function">getDisplayName</span><span class="token template-string interpolation punctuation">(</span><span class="token template-string interpolation maybe-class-name">WrappedComponent</span><span class="token template-string interpolation punctuation">)</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string">)</span><span class="token template-string template-punctuation string">`</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment">//或</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">HOC</span><span class="token plain"> </span><span class="token keyword">extends</span><span class="token plain"> </span><span class="token class-name punctuation">.</span><span class="token class-name punctuation">.</span><span class="token class-name punctuation">.</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">static</span><span class="token plain"> displayName </span><span class="token operator">=</span><span class="token plain"> </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">HOC(</span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation function">getDisplayName</span><span class="token template-string interpolation punctuation">(</span><span class="token template-string interpolation maybe-class-name">WrappedComponent</span><span class="token template-string interpolation punctuation">)</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string">)</span><span class="token template-string template-punctuation string">`</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token spread operator">...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p><em>getDisplayName</em> 函数：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">getDisplayName</span><span class="token punctuation">(</span><span class="token parameter maybe-class-name">WrappedComponent</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token maybe-class-name">WrappedComponent</span><span class="token punctuation">.</span><span class="token property-access">displayName</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">         </span><span class="token maybe-class-name">WrappedComponent</span><span class="token punctuation">.</span><span class="token property-access">name</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">         ‘Component’</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>实际上你不用自己写，<a target="_blank" rel="noopener noreferrer" href="https://link.zhihu.com/?target=https%3A//github.com/acdlite/recompose">recompose<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 提供了这个函数。</p></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/weisuoke/fe-interview-guidebook/edit/master/docs/react/basic/003.md">Edit this doc on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="Last update: ">3/6/2022 15:43:57</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="/umi.js"></script>
    <script src="/docs__react__basic__003.md.js"></script>
  </body>
</html>
