<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <script>
      window.routerBase = "/";
    </script>
    <script>
      //! umi version: 3.5.21
    </script>
    <script>
      !(function () {
        var e = localStorage.getItem("dumi:prefers-color"),
          t = window.matchMedia("(prefers-color-scheme: dark)").matches,
          r = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === r[2] ? (t ? r[1] : r[0]) : r.indexOf(e) > -1 ? e : r[0]
        );
      })();
    </script>
    <title>Fiber - 前端面试手册</title>
  
</head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/react/basic/004" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" href="/">前端面试手册</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span><a href="/js">JavaScript</a></span><span><a href="/css">CSS</a></span><span><a aria-current="page" class="active" href="/react">React</a></span><span><a href="/explorer">浏览器</a></span><span><a href="/network">网络</a></span><span><a href="/webpack">Webpack</a></span><span><a href="/node">Node</a></span><span><a href="/gof">设计模式</a></span><span><a href="/security">安全</a></span><span><a href="/algorithm">算法</a></span><span><a href="/skill">软技能</a></span><span><a href="/v8">V8</a></span><span><a href="/optimize">性能优化</a></span><span><a href="/wiki">Wiki</a></span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" href="/"></a><h1>前端面试手册</h1><p>前端面试手册</p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a href="/js">JavaScript</a></li><li><a href="/css">CSS</a></li><li><a aria-current="page" class="active" href="/react">React</a></li><li><a href="/explorer">浏览器</a></li><li><a href="/network">网络</a></li><li><a href="/webpack">Webpack</a></li><li><a href="/node">Node</a></li><li><a href="/gof">设计模式</a></li><li><a href="/security">安全</a></li><li><a href="/algorithm">算法</a></li><li><a href="/skill">软技能</a></li><li><a href="/v8">V8</a></li><li><a href="/optimize">性能优化</a></li><li><a href="/wiki">Wiki</a></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a target="_blank" rel="noopener noreferrer">基础</a><ul><li><a href="/react"><span>概述</span></a></li><li><a href="/react/basic/001"><span>setState的执行机制</span></a></li><li><a href="/react/basic/002"><span>合成事件</span></a></li><li><a href="/react/basic/003"><span>HOC</span></a></li><li><a aria-current="page" class="active" href="/react/basic/004"><span>Fiber</span></a></li></ul></li><li><a target="_blank" rel="noopener noreferrer">Redux</a><ul><li><a href="/react/redux/001"><span>Reudx原则</span></a></li></ul></li><li><a target="_blank" rel="noopener noreferrer">一灯学堂</a><ul><li><a href="/react/yideng"><span>React面试题</span></a></li><li><a href="/react/yideng/001"><span>React组件通信</span></a></li><li><a href="/react/yideng/003"><span>redux-saga 和 mobx 的比较</span></a></li><li><a href="/react/yideng/004"><span>React 项目中有哪些细节可以优化？实际开发中都做过哪些性能优化</span></a></li><li><a href="/react/yideng/005"><span>React 事件绑定原理</span></a></li><li><a href="/react/yideng/006"><span>react 最新版本解决了什么问题 加了哪些东西</span></a></li><li><a href="/react/yideng/009"><span>React兄弟组件的通信方式？</span></a></li><li><a href="/react/yideng/010"><span>Fiber算法原理，相比之前的stack算法哪些方面做了优化</span></a></li><li><a href="/react/yideng/012"><span>Props和State的区别</span></a></li><li><a href="/react/yideng/013"><span>对无状态组件的理解</span></a></li><li><a href="/react/yideng/016"><span>Redux 和全局管理有什么区别</span></a></li><li><a href="/react/yideng/017"><span>哪些方法会触发react重新渲染？重新渲染render会做些什么？</span></a></li><li><a href="/react/yideng/020"><span>React中setState后发生了什么？setState为什么默认是异步？setState什么时候是同步？</span></a></li><li><a href="/react/yideng/031"><span>Redux如何优化？</span></a></li><li><a href="/react/yideng/032"><span>如何实现 Redux 异步功能？</span></a></li><li><a href="/react/yideng/033"><span>说说 React 状态复用问题</span></a></li><li><a href="/react/yideng/034"><span>React Hooks 实现原理</span></a></li></ul></li><li><a target="_blank" rel="noopener noreferrer">React基础</a><ul><li><a href="/react/1.basic/01"><span>说一下你对React的理解</span></a></li><li><a href="/react/1.basic/02"><span>为什么React会引入JSX?</span></a></li><li><a href="/react/1.basic/03"><span>请说一下你对 Virtual DOM的理解？</span></a></li><li><a href="/react/1.basic/04"><span>函数组件和类组件的相同点和不同点?</span></a></li><li><a href="/react/1.basic/05"><span>请说一下 React 中的渲染流程</span></a></li><li><a href="/react/1.basic/06"><span>请说一下React中有DOM-DIFF算法?</span></a></li><li><a href="/react/1.basic/07"><span>合成事件</span></a></li><li><a href="/react/1.basic/08"><span>setState是同步的还是异步的</span></a></li></ul></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="前言" data-depth="2"><a href="/react/basic/004#前言"><span>前言</span></a></li><li title="正文" data-depth="2"><a href="/react/basic/004#正文"><span>正文</span></a></li><li title="背景" data-depth="2"><a href="/react/basic/004#背景"><span>背景</span></a></li><li title="从 React Elements到Fiber nodes" data-depth="2"><a href="/react/basic/004#从-react-elements到fiber-nodes"><span>从 React Elements到Fiber nodes</span></a></li><li title="React Elements" data-depth="2"><a href="/react/basic/004#react-elements"><span>React Elements</span></a></li><li title="Fiber nodes" data-depth="2"><a href="/react/basic/004#fiber-nodes"><span>Fiber nodes</span></a></li><li title="Side-effects" data-depth="2"><a href="/react/basic/004#side-effects"><span>Side-effects</span></a></li><li title="Effects list" data-depth="2"><a href="/react/basic/004#effects-list"><span>Effects list</span></a></li><li title="Root of the fiber tree" data-depth="2"><a href="/react/basic/004#root-of-the-fiber-tree"><span>Root of the fiber tree</span></a></li><li title="Fiber node structure" data-depth="2"><a href="/react/basic/004#fiber-node-structure"><span>Fiber node structure</span></a></li><li title="General algorithm" data-depth="2"><a href="/react/basic/004#general-algorithm"><span>General algorithm</span></a></li><li title="DOM updates" data-depth="2"><a href="/react/basic/004#dom-updates"><span>DOM updates</span></a></li><li title="Post-mutation lifecycle methods" data-depth="2"><a href="/react/basic/004#post-mutation-lifecycle-methods"><span>Post-mutation lifecycle methods</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="fiber"><a aria-hidden="true" tabindex="-1" href="/react/basic/004#fiber"><span class="icon icon-link"></span></a>Fiber</h1><h2 id="前言"><a aria-hidden="true" tabindex="-1" href="/react/basic/004#前言"><span class="icon icon-link"></span></a><strong>前言</strong></h2><p>React16提出了Fiber结构，其能够将任务分片，划分优先级，同时能够实现类似于操作系统中对线程的抢占式调度，非常强大。</p><h2 id="正文"><a aria-hidden="true" tabindex="-1" href="/react/basic/004#正文"><span class="icon icon-link"></span></a><strong>正文</strong></h2><p>React是一个用于构建UI的JavaScript库，其<a target="_blank" rel="noopener noreferrer" href="https://link.zhihu.com/?target=https%3A//medium.freecodecamp.org/what-every-front-end-developer-should-know-about-change-detection-in-angular-and-react-508f83f58c6a">核心<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>是跟踪组件状态变化并将更新到view上。在React中，我们将此过程视为<strong>reconciliation</strong>。在调用setState方法后，框架会检查state或props是否已更改并在UI上重新呈现组件。</p><p>React的文档提供了一种更高层次的对这种机制的<a target="_blank" rel="noopener noreferrer" href="https://link.zhihu.com/?target=https%3A//reactjs.org/docs/reconciliation.html">描述<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：包含React元素的作用，生命周期方法和渲染方法，以及应用于组件子元素的diffing算法等相关内容。从render方法返回的不可变React元素树通常称为“Virtual DOM”。这个术语有助于早期向人们解释React，但它也引起了歧义，并且不再在React文档中使用。在本文中，将坚持称它为React元素的树。</p><p>除了React元素的树之外，框架总是有一个用于保持状态的内部实例树(internal instances)（组件，DOM节点等），与之相对的是跟具体平台有关的public instance，也被称为Host instance 。从React 16开始，React推出了该内部实例树的新实现以及负责操作树的算法，被称为Fiber。接下来我们将了解fiber架构带来的优势，<a target="_blank" rel="noopener noreferrer" href="https://link.zhihu.com/?target=https%3A//medium.com/dailyjs/the-how-and-why-on-reacts-usage-of-linked-list-in-fiber-67f1014d0eb7">了解React在fiber中使用链表的方式和原因<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p><p>这是本系列的第一篇文章，旨在教你React的内部架构。在本文中，我想提供其中的重要概念和以及与算法相关的数据结构。一旦我们有足够的背景，我们将探索用于遍历和处理fiber tree的算法和主要功能。本系列的下一篇文章将演示React如何使用该算法执行初始渲染和处理state以及props更新。从那里我们将继续讨论scheduler的详细信息，子协调过程以及构建effect list的机制。</p><h2 id="背景"><a aria-hidden="true" tabindex="-1" href="/react/basic/004#背景"><span class="icon icon-link"></span></a><strong>背景</strong></h2><p>首先写一个非常简单的程序：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword module">import</span><span class="token plain"> </span><span class="token imports maybe-class-name">React</span><span class="token imports punctuation">,</span><span class="token imports"> </span><span class="token imports punctuation">{</span><span class="token imports"> </span><span class="token imports maybe-class-name">Component</span><span class="token imports"> </span><span class="token imports punctuation">}</span><span class="token plain"> </span><span class="token keyword module">from</span><span class="token plain"> </span><span class="token string">&#x27;react&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword module">default</span><span class="token plain"> </span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">ClickCounter</span><span class="token plain"> </span><span class="token keyword">extends</span><span class="token plain"> </span><span class="token class-name">Component</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">super</span><span class="token punctuation">(</span><span class="token plain">props</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token literal-property property">count</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">handleClick</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">handleClick</span><span class="token punctuation">.</span><span class="token method function property-access">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">    </span><span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token literal-property property">count</span><span class="token operator">:</span><span class="token plain"> state</span><span class="token punctuation">.</span><span class="token property-access">count</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">    </span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token operator">&lt;</span><span class="token plain">button key</span><span class="token operator">=</span><span class="token string">&quot;1&quot;</span><span class="token plain"> onClick</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">handleClick</span><span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token maybe-class-name">Update</span><span class="token plain"> counter</span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">button</span><span class="token operator">&gt;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token operator">&lt;</span><span class="token plain">span key</span><span class="token operator">=</span><span class="token string">&quot;2&quot;</span><span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token punctuation">.</span><span class="token property-access">count</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">span</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>可以查看在线<a target="_blank" rel="noopener noreferrer" href="https://link.zhihu.com/?target=https%3A//stackblitz.com/edit/react-t4rdmh">实例<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。可以看到，它是一个非常简单的组件，它从render方法返回两个子元素button和span。单击button后，组件的state将在处理程序内更新，这会导致span元素的文本更新。</p><p>React会在<strong>reconciliation</strong>期间执行各种活动。例如，以下是React在上面这个程序中第一次渲染和状态更新之后执行的高级操作：</p><ol><li>更新state中的count属性</li><li>检索并比较ClickCounter子组件以及props</li><li>更新span元素的props</li></ol><p>同时，在reconciliation期间，还会执行其他活动包括<a target="_blank" rel="noopener noreferrer" href="https://link.zhihu.com/?target=https%3A//reactjs.org/docs/react-component.html%23updating">调用生命周期方法<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>或<a target="_blank" rel="noopener noreferrer" href="https://link.zhihu.com/?target=https%3A//reactjs.org/docs/refs-and-the-dom.html">更新引用<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。所有这些活动在fiber架构中统称为“work”。work类型通常取决于React元素的类型。例如，对于class组件，React需要创建实例，而不是为function组件执行此操作。并且，React中有许多元素，例如：class和function组件，Host组件（DOM节点），protals等. React元素的类型由createElement函数的第一个参数定义，此函数通常在render方法中用于创建元素。<strong>总结起来，就是更新组件的内部状态，触发side-effects执行。</strong></p><p>在我们开始探索fiber算法之前，让我们首先熟悉React内部使用的数据结构。</p><h2 id="从-react-elements到fiber-nodes"><a aria-hidden="true" tabindex="-1" href="/react/basic/004#从-react-elements到fiber-nodes"><span class="icon icon-link"></span></a><strong>从 React Elements到Fiber nodes</strong></h2><p>React中的每个组件都有一个UI表示，这个UI可以通过调用一个view或一个从render方法返回。这是ClickCounter组件的模板：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token operator">&lt;</span><span class="token plain">button key</span><span class="token operator">=</span><span class="token string">&quot;1&quot;</span><span class="token plain"> onClick</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">onClick</span><span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token maybe-class-name">Update</span><span class="token plain"> counter</span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">button</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token operator">&lt;</span><span class="token plain">span key</span><span class="token operator">=</span><span class="token string">&quot;2&quot;</span><span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token punctuation">.</span><span class="token property-access">count</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">span</span><span class="token operator">&gt;</span></div></pre></div><h2 id="react-elements"><a aria-hidden="true" tabindex="-1" href="/react/basic/004#react-elements"><span class="icon icon-link"></span></a><strong>React Elements</strong></h2><p>一旦模板通过JSX编译器编译，就会得到一堆React元素。这是从React组件的render方法返回的，而不是HTML。由于我们不需要使用JSX，因此我们的ClickCounter组件的render方法可以像这样重写：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">ClickCounter</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token spread operator">...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token method function property-access">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token maybe-class-name">React</span><span class="token punctuation">.</span><span class="token method function property-access">createElement</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                </span><span class="token string">&#x27;button&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                    </span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;1&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                    </span><span class="token literal-property property">onClick</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">onClick</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                </span><span class="token string">&#x27;Update counter&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token maybe-class-name">React</span><span class="token punctuation">.</span><span class="token method function property-access">createElement</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                </span><span class="token string">&#x27;span&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                    </span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;2&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token punctuation">.</span><span class="token property-access">count</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>在render方法中调用React.createElement会创建两个数据结构：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        $$</span><span class="token keyword">typeof</span><span class="token operator">:</span><span class="token plain"> </span><span class="token known-class-name class-name">Symbol</span><span class="token punctuation">(</span><span class="token plain">react</span><span class="token punctuation">.</span><span class="token property-access">element</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;button&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token literal-property property">props</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token literal-property property">children</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;Update counter&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token function-variable function">onClick</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token spread operator">...</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        $$</span><span class="token keyword">typeof</span><span class="token operator">:</span><span class="token plain"> </span><span class="token known-class-name class-name">Symbol</span><span class="token punctuation">(</span><span class="token plain">react</span><span class="token punctuation">.</span><span class="token property-access">element</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;span&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token literal-property property">props</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token literal-property property">children</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span></div></pre></div><p>可以看到React将$$typeof属性添加到这些对象，以将它们唯一地标识为React元素。然后我们可以通过type，key和props属性来描述元素。这些值取自传递给React.createElement函数的值。请注意React如何将文本内容表示为span和button节点的子项，以及click处理程序如何成为按钮元素props的一部分。 React元素上还有其他字段，如ref字段，超出了本文的范围，不再阐述。</p><p>同时ClickCouter元素没有任何的props或者key:</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    $$</span><span class="token keyword">typeof</span><span class="token operator">:</span><span class="token plain"> </span><span class="token known-class-name class-name">Symbol</span><span class="token punctuation">(</span><span class="token plain">react</span><span class="token punctuation">.</span><span class="token property-access">element</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">props</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">ref</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">ClickCounter</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><h2 id="fiber-nodes"><a aria-hidden="true" tabindex="-1" href="/react/basic/004#fiber-nodes"><span class="icon icon-link"></span></a><strong>Fiber nodes</strong></h2><p>在reconciliation期间，来自render方法返回的每个React元素的数据被合并到fiber node树中，每个React元素都有一个相应的fiber node。与React元素不同，每次渲染过程，不会再重新创建fiber。这些可变的数据包含组件state和DOM。 我们之前讨论过，根据React元素的类型，框架需要执行不同的活动。在我们的示例应用程序中，对于class组件ClickCounter，它调用生命周期方法和render方法，而对于span Host 组件（DOM节点），它执行DOM更新。因此，每个React元素都会转换为相应类型的Fiber节点，用于描述需要完成的工作。</p><p>可以这样认为：<strong>fiber作为一种数据结构，用于代表某些worker，换句话说，就是一个work单元，通过Fiber的架构，提供了一种跟踪，调度，暂停和中止工作的便捷方式。</strong></p><p>当React元素第一次转换为fiber节点时，React使用createElement返回的数据来创建fiber，这段代码在<a target="_blank" rel="noopener noreferrer" href="https://link.zhihu.com/?target=https%3A//github.com/facebook/react/blob/769b1f270e1251d9dbdce0fcbd9e92e502d059b8/packages/react-reconciler/src/ReactFiber.js%23L414">createFiberFromTypeAndProps<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 函数中。在随后的更新中，React重用fiber节点，并使用来自相应React元素的数据来更新必要的属性。如果不再从render方法返回相应的React元素，React可能还需要根据key来移动层次结构中的节点或删除它。</p><p>可以查看<a target="_blank" rel="noopener noreferrer" href="https://link.zhihu.com/?target=https%3A//github.com/facebook/react/blob/95a313ec0b957f71798a69d8e83408f40e76765b/packages/react-reconciler/src/ReactChildFiber.js%23L239">ChildReconciler<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>函数的实现，来了解React为现有fiber节点执行的所有活动和相应函数的列表。因为React为每个React元素创建了一个fiber node，并且因为我们有一个这些元素的树，所以我们将拥有一个fiber node tree。对于我们的示例应用程序，它看起来像这样：</p><p><img src="http://wuxiao-tech-doc.oss-cn-hangzhou.aliyuncs.com/2022-02-19-121639.jpg" alt="img"/></p><p>所有fiber节点都通过使用fiber节点上的以下属性：child，sibling和return来构成一个fiber node的linked list(后面我们称之为链表)。有关它为什么以这种方式工作的更多详细信息，可以查看<a target="_blank" rel="noopener noreferrer" href="https://link.zhihu.com/?target=https%3A//medium.com/dailyjs/the-how-and-why-on-reacts-usage-of-linked-list-in-fiber-67f1014d0eb7">这篇文章<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p><p><strong>Current and work in progress trees</strong></p><p>在第一次渲染之后，React最终得到一个fiber tree，它反映了用于渲染UI的应用程序的状态。这棵树通常被称为current tree。当React开始处理更新时，它会构建一个所谓的workInProgress tree，它反映了要刷新到屏幕的未来状态。</p><p>所有work都在workInProgress tree中的fiber上执行。当React遍历current tree时，对于每个现有fiber节点，它会使用render方法返回的React元素中的数据创建一个备用(alternate)fiber节点，这些节点用于构成workInProgress tree(备用tree)。处理完更新并完成所有相关工作后，React将备用tree刷新到屏幕。一旦这个workInProgress tree在屏幕上呈现，它就会变成current tree。</p><p>React的核心原则之一是一致性。 React总是一次更新DOM - 它不会显示部分结果。 workInProgress tree对用户不可见，因此React可以先处理完所有组件，然后将其更改刷新到屏幕。</p><p>在源代码中，可以看到很多函数从current tree和workInProgress tree中获取fiber节点：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">updateHostComponent</span><span class="token punctuation">(</span><span class="token parameter">current</span><span class="token parameter punctuation">,</span><span class="token parameter"> workInProgress</span><span class="token parameter punctuation">,</span><span class="token parameter"> renderExpirationTime</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token spread operator">...</span><span class="token punctuation">}</span></div></pre></div><p>每个fiber节点都会通过alternate字段保持对另一个树的对应节点的引用。current tree中的节点指向workInProgress tree中的备用节点，反之亦然。</p><h2 id="side-effects"><a aria-hidden="true" tabindex="-1" href="/react/basic/004#side-effects"><span class="icon icon-link"></span></a><strong>Side-effects</strong></h2><p>我们可以将React中的一个组件视为一个使用state和props来计算UI的函数。每个其他活动，如改变DOM或调用生命周期方法，都应该被认为是side-effects，react文档中是这样描述的side-effects的：</p><blockquote><p><em>You’ve likely performed data fetching, subscriptions, or manually</em> <strong>changing the DOM 的</strong><em>from React components before. We call these operations “side effects” (or “effects” for short) because they can affect other components and can’t be done during rendering.</em></p></blockquote><p>可以看到大多数state和props更新将side-effects。由于应用effects是一种work，fiber节点是一种方便的机制，可以跟踪除更新之外的effects。每个fiber节点都可以具有与之相关的effects, 通过fiber节点中的effectTag字段表示。</p><p>因此，Fiber中的effects基本上定义了处理更新后需要为实例完成的工作，对于Host组件（DOM元素），工作包括添加，更新或删除元素。对于class组件，React可能需要更新ref并调用componentDidMount和componentDidUpdate生命周期方法，还存在与其他类型的fiber相对应的其他effects。</p><h2 id="effects-list"><a aria-hidden="true" tabindex="-1" href="/react/basic/004#effects-list"><span class="icon icon-link"></span></a><strong>Effects list</strong></h2><p>React能够非常快速地更新，并且为了实现高性能，它采用了一些有趣的技术。其中之一是构建带有side-effects的fiber节点的线性列表，其具有快速迭代的效果。迭代线性列表比树快得多，并且没有必要在没有side effects的节点上花费时间。</p><p>此列表的目标是标记具有DOM更新或与其关联的其他effects的节点，此列表是finishedWork tree的子集，并使用nextEffect属性，而不是current和workInProgress树中使用的child属性进行链接。</p><p>Dan Abramove为effecs list提供了一个类比: 他喜欢将它想象成一棵圣诞树，“圣诞灯”将所有带有effects的节点绑定在一起。为了使这个effects list可视化，让我们想象下面的fiber node tree，其中<strong>橙色的节点都有一些effects需要处理</strong>。例如，我们的更新导致c2被插入到DOM中，d2和c1被用于更改属性，而b2被用于激活生命周期方法。effects list将它们链接在一起，以便React可以在以后跳过其他节点：</p><p><img src="http://wuxiao-tech-doc.oss-cn-hangzhou.aliyuncs.com/2022-02-19-121628.jpg" alt="img"/></p><p>你可以看到带有effects的节点是如何链接在一起的，当遍历节点时，React使用firstEffect指针来确定effects list的开始位置。所以上图可以表示为这样的线性列表</p><p><img src="http://wuxiao-tech-doc.oss-cn-hangzhou.aliyuncs.com/2022-02-19-121630.png" alt="img"/></p><h2 id="root-of-the-fiber-tree"><a aria-hidden="true" tabindex="-1" href="/react/basic/004#root-of-the-fiber-tree"><span class="icon icon-link"></span></a><strong>Root of the fiber tree</strong></h2><p>每个React应用程序都有一个或多个作为container的DOM元素。在我们的例子中，它是带有id为“container”的div元素。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> domContainer </span><span class="token operator">=</span><span class="token plain"> </span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">querySelector</span><span class="token punctuation">(</span><span class="token string">&#x27;#container&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token maybe-class-name">ReactDOM</span><span class="token punctuation">.</span><span class="token method function property-access">render</span><span class="token punctuation">(</span><span class="token maybe-class-name">React</span><span class="token punctuation">.</span><span class="token method function property-access">createElement</span><span class="token punctuation">(</span><span class="token maybe-class-name">ClickCounter</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"> domContainer</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><p>React为每个container创建一个fiber root 对象，可以使用对DOM元素的引用来访问它：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> fiberRoot </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">&#x27;#container&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">_reactRootContainer</span><span class="token punctuation">.</span><span class="token property-access">_internalRoot</span></div></pre></div><p>这个fiber root 是React保存对fiber tree引用的地方。它存储在fiber tree的current属性中：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> hostRootFiberNode </span><span class="token operator">=</span><span class="token plain"> fiberRoot</span><span class="token punctuation">.</span><span class="token property-access">current</span></div></pre></div><p>fiber tree以特殊类型的fiber节点（HostRoot）开始。它是在内部创建的，并充当最顶层组件的父级，HostRoot fiber节点通过stateNode属性指向FiberRoot：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">fiberRoot</span><span class="token punctuation">.</span><span class="token property-access">current</span><span class="token punctuation">.</span><span class="token property-access">stateNode</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> fiberRoot</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// true</span></div></pre></div><p>可以通过fiber root访问最顶端的HostRoot的fiber node来探索fiber tree。或者，可以从组件实例中获取单个fiber节点，如下所示：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">compInstance</span><span class="token punctuation">.</span><span class="token property-access">_reactInternalFiber</span></div></pre></div><h2 id="fiber-node-structure"><a aria-hidden="true" tabindex="-1" href="/react/basic/004#fiber-node-structure"><span class="icon icon-link"></span></a><strong>Fiber node structure</strong></h2><p>现在让我们看一下为ClickCounter组件创建的fiber节点的结构：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">stateNode</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">ClickCounter</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">ClickCounter</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">alternate</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">updateQueue</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">memoizedState</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token literal-property property">count</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">pendingProps</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">memoizedProps</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">tag</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">effectTag</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">nextEffect</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>以及span节点：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">stateNode</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">HTMLSpanElement</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&quot;span&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">alternate</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">updateQueue</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">memoizedState</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">pendingProps</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token literal-property property">children</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">memoizedProps</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token literal-property property">children</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">tag</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">5</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">effectTag</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">nextEffect</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>fiber节点上有很多字段，我在前面的部分中描述了alternate字段，effectTag和nextEffect的用途。现在让我们看看为什么我们需要其他字段：</p><ul><li>**stateNode：**保存对组件的类实例，DOM节点或与fiber节点关联的其他React元素类型的引用。一般来说，可以认为这个属性用于保存与fiber相关的本地状态。</li><li>**type：**定义与此fiber关联的功能或类。对于类组件，它指向构造函数；对于DOM元素，它指定HTML tag。可以使用这个字段来理解fiber节点与哪个元素相关。</li><li>**tag：**定义fiber的类型。它在reconcile算法中用于确定需要完成的工作。如前所述，工作取决于React元素的类型，函数<a target="_blank" rel="noopener noreferrer" href="https://link.zhihu.com/?target=https%3A//github.com/facebook/react/blob/769b1f270e1251d9dbdce0fcbd9e92e502d059b8/packages/react-reconciler/src/ReactFiber.js%23L414">createFiberFromTypeAndProps<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>将React元素映射到相应的fiber节点类型。在我们的应用程序中，ClickCounter组件的属性标记是1，表示ClassComponent，而span元素的属性标记是5，表示Host Component。</li><li>**updateQueue：**用于状态更新，回调函数，DOM更新的队列</li><li>**memoizedState：**用于创建输出的fiber状态。处理更新时，它会反映当前在屏幕上呈现的状态。</li><li>**memoizedProps：**在前一次渲染期间用于创建输出的props</li><li>**pendingProps：**已从React元素中的新数据更新，并且需要应用于子组件或DOM元素的props</li><li>**key：**具有一组children的唯一标识符，可帮助React确定哪些项已更改，已添加或从列表中删除。它与此处描述的React的“<a target="_blank" rel="noopener noreferrer" href="https://link.zhihu.com/?target=https%3A//reactjs.org/docs/lists-and-keys.html%23keys">list and key<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>”功能有关。</li></ul><p>可以在<a target="_blank" rel="noopener noreferrer" href="https://link.zhihu.com/?target=https%3A//github.com/facebook/react/blob/6e4f7c788603dac7fccd227a4852c110b072fe16/packages/react-reconciler/src/ReactFiber.js%23L78">此处<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>找到fiber节点的完整结构。在上面的解释中省略了一堆字段，尤其跳过了child，sibling和return，组成了树数据结构。以及特定于Scheduler的expirationTime，childExpirationTime和mode等字段类别。</p><h2 id="general-algorithm"><a aria-hidden="true" tabindex="-1" href="/react/basic/004#general-algorithm"><span class="icon icon-link"></span></a><strong>General algorithm</strong></h2><p>React把一次渲染分为两个阶段：<strong>render</strong>和<strong>commit</strong>。</p><p>在render阶段时，React通过setState或React.render来执行组件的更新，并确定需要在UI中更新的内容。如果是第一次渲染，React会为render方法返回的每个元素，创建一个新的fiber节点。在接下来的更新中，将重用和更新现有React元素的fiber 节点。render阶段的结果是<strong>生成一个部分节点标记了side effects的fiber节点树</strong>，side effects描述了在下一个commit阶段需要完成的工作。在此阶段，React采用标有side effects的fiber树并将其应用于实例。它遍历side effects列表并执行DOM更新和用户可见的其他更改。</p><p>一个很重要的点是，<strong>render阶段可以异步执行</strong>。 React可以根据可用时间来处理一个或多个fiber节点，然后停止已完成的工作，并让出调度权来处理某些事件。然后它从它停止的地方继续。但有时候，它可能需要丢弃完成的工作并再次从头。由于在render阶段执行的工作不会导致任何用户可见的更改（如DOM更新），因此这些暂停是不会有问题的。相反，在接下来的commit阶段始终是同步的，这是因为在此阶段执行的工作，将会生成用户可见的变化，例如， DOM更新，这就是React需要一次完成它们的原因。</p><p>调用生命周期方法是React执行的一种工作。在render阶段调用某些方法，在commit阶段调用其他方法。在render阶段时调用的生命周期列表如下：</p><ul><li>[UNSAFE_]componentWillMount (已废弃)</li><li>[UNSAFE_]componentWillReceiveProps (已废弃)</li><li>getDerivedStateFromProps</li><li>shouldComponentUpdate</li><li>[UNSAFE_]componentWillUpdate (已废弃)</li><li>render</li></ul><p>可以看到，在render阶段执行的一些遗留生命周期方法在react 16.3中标记为UNSAFE。它们现在在文档中称为遗留生命周期，将在未来的16.x版本中弃用，而没有UNSAFE前缀的版本将在17.0中删除。可以在此处详细了解这些<a target="_blank" rel="noopener noreferrer" href="https://link.zhihu.com/?target=https%3A//reactjs.org/blog/2018/03/27/update-on-async-rendering.html">更改以及建议的迁移路径<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p><p>为什么会废弃这些声明周期函数呢呢？</p><p>因为在render阶段不会产生像DOM更新这样的副作用，所以React可以异步处理与组件异步的更新（甚至可能在多个线程中执行）。然而，标有UNSAFE的生命周期经常被误解和滥用，开发人员倾向于将带有副作用的代码放在这些方法中，这可能会导致新的异步渲染方法出现问题。虽然只有没有UNSAFE前缀的副本会被删除，但它们仍然可能在即将出现的concurrent模式中引起问题。</p><p>以下是commit阶段执行的生命周期方法列表：</p><ul><li>getSnapshotBeforeUpdate</li><li>componentDidMount</li><li>componentDidUpdate</li><li>componentWillUnmount</li></ul><p>因为这些方法在同步commit阶段执行，所以它们可能包含副作用并获取DOM。</p><p><strong>Render阶段</strong></p><p>reconciliation算法始终使用<a target="_blank" rel="noopener noreferrer" href="https://link.zhihu.com/?target=https%3A//github.com/facebook/react/blob/95a313ec0b957f71798a69d8e83408f40e76765b/packages/react-reconciler/src/ReactFiberScheduler.js%23L1132">renderRoot<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>函数从最顶端的HostRoot fiber节点开始。但是，React会跳过已经处理过的fiber节点，直到找到未完成工作的节点。例如，如果在组件树中调用setState，则React将从顶部开始，但会快速跳过父节点，直到它到达调用了setState方法的组件。</p><p><strong>Main steps of the work loop</strong></p><p>所有fiber节点都在<a target="_blank" rel="noopener noreferrer" href="https://link.zhihu.com/?target=https%3A//github.com/facebook/react/blob/f765f022534958bcf49120bf23bc1aa665e8f651/packages/react-reconciler/src/ReactFiberScheduler.js%23L1136">work loop<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>中处理。这是循环的同步部分的实现</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">workLoop</span><span class="token punctuation">(</span><span class="token parameter">isYieldy</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">isYieldy</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">nextUnitOfWork </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      nextUnitOfWork </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token plain">nextUnitOfWork</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token spread operator">...</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>在上面的代码中，nextUnitOfWork从workInProgress树中保存对fiber节点(这些节点有部分任务要处理)的引用。当React遍历Fibers树时，它使用此变量来知道是否有任何其他fiber节点具有未完成的工作。处理当前fiber后，变量将包含对树中下一个fiber节点的引用或null。在这种情况下，React退出工作循环并准备提交更改.</p><p>有4个主要功能用于遍历树并启动或完成工作:</p><ul><li><a target="_blank" rel="noopener noreferrer" href="https://link.zhihu.com/?target=https%3A//github.com/facebook/react/blob/95a313ec0b957f71798a69d8e83408f40e76765b/packages/react-reconciler/src/ReactFiberScheduler.js%23L1056">performUnitOfWork<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a target="_blank" rel="noopener noreferrer" href="https://link.zhihu.com/?target=https%3A//github.com/facebook/react/blob/cbbc2b6c4d0d8519145560bd8183ecde55168b12/packages/react-reconciler/src/ReactFiberBeginWork.js%23L1489">beginWork<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a target="_blank" rel="noopener noreferrer" href="https://link.zhihu.com/?target=https%3A//github.com/facebook/react/blob/95a313ec0b957f71798a69d8e83408f40e76765b/packages/react-reconciler/src/ReactFiberScheduler.js%23L879">completeUnitOfWork<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a target="_blank" rel="noopener noreferrer" href="https://link.zhihu.com/?target=https%3A//github.com/facebook/react/blob/cbbc2b6c4d0d8519145560bd8183ecde55168b12/packages/react-reconciler/src/ReactFiberCompleteWork.js%23L532">completeWork<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul><p>要演示如何使用它们，请查看以下遍历fiber树的动画。已经在演示中使用了这些函数的简化实现。每个函数都需要一个fiber节点进行处理，当React从树上下来时，可以看到当前活动的fiber节点发生了变化，可以清楚地看到算法如何从一个分支转到另一个分支。它首先完成child 节点的工作，然后转移到parent身边.</p><p><img src="http://wuxiao-tech-doc.oss-cn-hangzhou.aliyuncs.com/2022-02-19-121619.jpg" alt="img"/></p><blockquote><p>注意，垂直连接表示sibling，而弯曲的连接表示child，例如b1没有child，而b2有一个childc1.</p></blockquote><p>这是<a target="_blank" rel="noopener noreferrer" href="https://link.zhihu.com/?target=https%3A//vimeo.com/302222454">视频的链接<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，您可以在其中暂停播放并检查当前节点和功能状态，可以简单的看到，这里适用的树遍历算法是<strong>深度优先搜索(DFS)</strong></p><p>让我们从前两个函数performUnitOfWork和beginWork开始:</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter">workInProgress</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">let</span><span class="token plain"> next </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">beginWork</span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">next </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        next </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">completeUnitOfWork</span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> next</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">beginWork</span><span class="token punctuation">(</span><span class="token parameter">workInProgress</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;work performed for &#x27;</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">child</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>performUnitOfWork函数从workInProgress树接收fiber节点，并通过调用beginWork函数启动工作，即通过这个函数启动fiber需要执行的所有活动。出于演示的目的，我们只需记录fiber的名称即可表示已完成工作。beginWork函数始终返回要在循环中处理的下一个子节点的指针或null.</p><p>如果有下一个子节点，它将被赋值给workLoop函数中的nextUnitOfWork变量。但是，如果没有子节点，React知道它到达了分支的末尾，因此它就完成当前节点。一旦节点完成，它将需要为兄弟节点执行工作并在此之后回溯到父节点。这是在completeUnitOfWork函数中完成的.</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">completeUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter">workInProgress</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">let</span><span class="token plain"> returnFiber </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token keyword control-flow">return</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">let</span><span class="token plain"> siblingFiber </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">sibling</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">        nextUnitOfWork </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">completeWork</span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">siblingFiber </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token comment">// If there is a sibling, return it</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token comment">// to perform work for this sibling</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword control-flow">return</span><span class="token plain"> siblingFiber</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">returnFiber </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token comment">// If there&#x27;s no more work in this returnFiber,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token comment">// continue the loop to complete the parent.</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            workInProgress </span><span class="token operator">=</span><span class="token plain"> returnFiber</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword control-flow">continue</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token comment">// We&#x27;ve reached the root.</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">completeWork</span><span class="token punctuation">(</span><span class="token parameter">workInProgress</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;work completed for &#x27;</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>可以看到函数的重点是一个很大的循环。当workInProgress节点没有子节点时，React会进入此函数。完成当前fiber的工作后，它会检查是否有兄弟节点；如果找到，React退出该函数并返回指向兄弟节点的指针。它将被赋值给nextUnitOfWork变量，React将从这个兄弟开始执行分支的工作。重要的是要理解，在这一点上，React只完成了前面兄弟姐妹的工作。它尚未完成父节点的工作，只有在完成所有子节点工作后，才能完成父节点和回溯的工作.</p><p>从实现中可以看出，performUnitOfWork和completeUnitOfWork主要用于迭代目的，而主要活动则在beginWork和completeWork函数中进行。在后面的部分，我们将了解当React进入beginWork和completeWork函数时，ClickCounter组件和span节点会发生什么.</p><p><strong>Commit phase</strong></p><p>该阶段以completeRoot函数开始，这是React更新DOM并调用mutation生命周期方法的地方。</p><p>当React进入这个阶段时，它有2棵树和effects list。第一棵树是current tree, 表示当前在屏幕上呈现的状态，然后是在渲染阶段构建了一个备用树，它在源代码中称为finishedWork或workInProgress，表示需要在屏幕上反映的状态。此备用树通过子节点和兄弟节点指针来与current树类似地链接。</p><p>然后，有一个effects list - 通过nextEffect指针链接的，finishedWork树中节点的子集。请记住，effects list 是render阶段运行的结果。render阶段的重点是确定需要插入，更新或删除哪些节点，以及哪些组件需要调用其生命周期方法，其最终生成了effects list，也正是在提交阶段迭代的节点集。</p><p>出于调试目的，可以通过fiber root的current属性访current tree，可以通过current tree中HostFiber节点的alternate属性访问finishedWork树。</p><p>在提交阶段运行的主要功能是<a target="_blank" rel="noopener noreferrer" href="https://link.zhihu.com/?target=https%3A//github.com/facebook/react/blob/95a313ec0b957f71798a69d8e83408f40e76765b/packages/react-reconciler/src/ReactFiberScheduler.js%23L523">commitRoot<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。它会执行以下操作:</p><ul><li>在标记了Snapshot effect的节点上使用getSnapshotBeforeUpdate生命周期方法</li><li>在标记了Deletion effect的节点上调用componentWillUnmount生命周期方法</li><li>执行所有DOM插入，更新和删除</li><li>将finishedWork树设置为current树</li><li>在标记了Placement effect的节点上调用componentDidMount生命周期方法</li><li>在标记了Update effect的节点上调用componentDidUpdate生命周期方法</li></ul><p>在调用pre-mutation方法getSnapshotBeforeUpdate之后，React会在树中提交所有side-effects。它通过两个部分：第一部分执行所有DOM（Host）插入，更新，删除和ref卸载，然后，React将finishedWork树分配给FiberRoot，将workInProgress树标记为current树。前面这些都是在commit阶段的第一部分完成的，因此在componentWillUnmount中指向的仍然是前一个树，但在第二部分之前，因此在componentDidMount / Update中指向的是最新的树。在第二部分中，React调用所有其他生命周期方法和ref callback, 这些方法将会单独执行，因此已经调用了整个树中的所有放置(placement)，更新和删除.</p><p>下面这段代码运行上述步骤的函数的要点，其中root.current=finishWork及以前为第一部分，其之后为第二部分.</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token parameter">root</span><span class="token parameter punctuation">,</span><span class="token parameter"> finishedWork</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">commitBeforeMutationLifecycles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">commitAllHostEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    root</span><span class="token punctuation">.</span><span class="token property-access">current</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> finishedWork</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">commitAllLifeCycles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>这些子函数中的每一个都实现了一个循环，该循环遍历effects list并检查effect的类型, 当它找到与函数功能相关的effects时，就会执行它.</p><p><strong>Pre-mutation lifecycle methods</strong></p><p>例如，这是在effect tree上迭代并检查节点是否具有Snapshot effect的代码:</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">commitBeforeMutationLifecycles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">nextEffect </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">const</span><span class="token plain"> effectTag </span><span class="token operator">=</span><span class="token plain"> nextEffect</span><span class="token punctuation">.</span><span class="token property-access">effectTag</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">effectTag </span><span class="token operator">&amp;</span><span class="token plain"> </span><span class="token maybe-class-name">Snapshot</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword">const</span><span class="token plain"> current </span><span class="token operator">=</span><span class="token plain"> nextEffect</span><span class="token punctuation">.</span><span class="token property-access">alternate</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token function">commitBeforeMutationLifeCycles</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> nextEffect</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        nextEffect </span><span class="token operator">=</span><span class="token plain"> nextEffect</span><span class="token punctuation">.</span><span class="token property-access">nextEffect</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>对于类组件，该effect意味着调用getSnapshotBeforeUpdate生命周期方法.</p><h2 id="dom-updates"><a aria-hidden="true" tabindex="-1" href="/react/basic/004#dom-updates"><span class="icon icon-link"></span></a><strong>DOM updates</strong></h2><p><a target="_blank" rel="noopener noreferrer" href="https://link.zhihu.com/?target=https%3A//github.com/facebook/react/blob/95a313ec0b957f71798a69d8e83408f40e76765b/packages/react-reconciler/src/ReactFiberScheduler.js%23L376">commitAllHostEffects<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>是React执行DOM更新的函数。该函数基本上定义了需要为节点完成并执行它的操作类型.</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">unction </span><span class="token function">commitAllHostEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">switch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">primaryEffectTag</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">Placement</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token function">commitPlacement</span><span class="token punctuation">(</span><span class="token plain">nextEffect</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token spread operator">...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">PlacementAndUpdate</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token function">commitPlacement</span><span class="token punctuation">(</span><span class="token plain">nextEffect</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token function">commitWork</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> nextEffect</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token spread operator">...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">Update</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token function">commitWork</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> nextEffect</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token spread operator">...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">Deletion</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token function">commitDeletion</span><span class="token punctuation">(</span><span class="token plain">nextEffect</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token spread operator">...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>有趣的是，React调用componentWillUnmount方法作为commitDeletion函数中删除过程的一部分.</p><h2 id="post-mutation-lifecycle-methods"><a aria-hidden="true" tabindex="-1" href="/react/basic/004#post-mutation-lifecycle-methods"><span class="icon icon-link"></span></a><strong>Post-mutation lifecycle methods</strong></h2><p><a target="_blank" rel="noopener noreferrer" href="https://link.zhihu.com/?target=https%3A//github.com/facebook/react/blob/95a313ec0b957f71798a69d8e83408f40e76765b/packages/react-reconciler/src/ReactFiberScheduler.js%23L465">commitAllLifecycles<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>是React调用所有剩余生命周期方法componentDidUpdate和componentDidMount的函数.</p></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/weisuoke/fe-interview-guidebook/edit/master/docs/react/basic/004.md">Edit this doc on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="Last update: ">3/6/2022 15:43:57</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="/umi.js"></script>
    <script src="/docs__react__basic__004.md.js"></script>
  </body>
</html>
